
# NodeVision Edit 要件定義書 v1.0.7
_画像・動画編集に特化した「ComfyUIスタイルのノードUI」アプリ。モデル/LoRA/ComfyUIワークフロー互換は対象外。_

更新日: 2025-11-12

---

## 1. 目的と範囲（変更なし・要約）
- 目的: **ComfyUIに近い操作感のノード型UI**で、ローカルの**画像/動画編集**を行う最小MVPを提供する。
- 範囲: キャンバス/ノードエディタ、基本編集ノード群、実行エンジン（DAG/キャンセル）、プレビュー、保存/読み込み、簡易キュー・履歴、FFmpeg/ffprobe。
- 非範囲: Stable Diffusion等の**モデル**、**LoRA**、ComfyUI **ワークフロー互換**、プラグイン、クラウド連携、音声編集（P1以降）。

---

## 2. 互換性とデータ管理（新規）
- **ノード識別子/バージョン**：各ノードは `typeId` と `nodeVersion` を持つ。メジャー変更時は**マイグレーション定義必須**（付録A）。
- **スキーマ移行**：`schemaVersion` が異なるプロジェクトは**自動マイグレーション**を試行。失敗時は**読み取り専用**で開く。
- **時間単位**：UIは秒（小数）表示、**内部/IPCはms**で統一。

---

## 3. 実行エンジン/リソース（追補）
- **並列度**：MVPは**同時実行=1**固定。プレビュー生成は実行と**直列**。P1で並列化検討。
- **ディスク/メモリ上限**：`tempRoot` 合計**1GB**上限（LRU削除）。単一ジョブの中間書き出しは**500MB**で早期失敗（`E3001 ResourceExceeded`）。
- **進捗の定義**：`JobProgress.ratio = 出力時間 / 総時間`。総時間不明時は推定→確定後に補正。
- **P1並列ロードマップ**：P1では`maxParallelJobs=2`、待機キューは**最大4件**。UIステータスは `Queued → Running → CoolingDown/Failed/Completed` を明示し、キュー滞留が**3分**を超えると自動キャンセル。
- **キャンセル優先度/UX**：`Cancel All` は **Running > Queued の順**でトークン化し、実行中ジョブは**2秒以内**に `Cancelling` 表示へ遷移。キャンセル結果はトースト＋ジョブ履歴に残す。

---

## 4. HTTP/IPC セキュリティ（強化）
- **ローカルHTTP**：既定OFF。`NV_HTTP=1` で有効。**localhost限定**、CORS無効、JSON 128KB上限。
- **トークン必須**：HTTP有効時は `NV_HTTP_TOKEN` を必須。ヘッダ `X-NodeVision-Token` が一致したときのみ受理（401/403対応）。
- **トークンライフサイクル**：CLI `nvctl token issue --label <name> --expires-in <30d>` で生成し、値はmacOS Keychain / Windows DPAPI / Linux Secret Serviceに保存。`nvctl token rotate <label>` は新トークン発行後**15分猶予**で旧トークンを失効、`nvctl token revoke <label>` は即時削除。30日を超過したトークンは`401 E4001 TokenExpired`を返し再発行を要求。
- **パス検証**：`clips[].path` は正規化し、**ローカルドライブのみ**許可。シンボリックリンクは解決して実体を検証。
- **レート制限/同時実行**：`/api/inspect/concat` は**同時2本まで**。キュー待機は**即時429**（MVP簡易）。
- **タイムアウト**：検査は**≤1s**。超過は `E1004 MediaProbeFailed` を返す。

---

## 5. UI/UX 操作（追補）
- **オートセーブ**：アイドル**2秒**で差分保存。実行中は**10秒**以上のアイドル時のみ。
- **配置ガイド**：グリッド**8px**。移動は**4px**スナップ。整列（左/上/中央）ボタンを提供。
- **ショートカット**：`Ctrl/Cmd+D`=複製、`Ctrl/Cmd+C/V`=コピー/貼付、`1`=100%、`Shift+1`=選択フィット。

---

## 6. プレビュー/色管理（追補）
- **色管理**：プレビューは**sRGB**前提、ICCは未対応（P1）。
- **補間品質**：プレビュー=**bilinear**、書き出し=**bicubic**。

---

## 7. ログ/診断（追補）
- **ログレベル**：`info/warn/error/debug`。直近**20ジョブ**のログを保持し、それ以前は自動削除。
- **クラッシュ**：ミニダンプ収集は**既定OFF**。明示同意でON。
- **ログエクスポート**：設定画面に「Export Logs」を追加し、保持中のジョブログ＋`inspect_concat`呼び出し履歴＋クラッシュダンプ（同意時）を `NodeVision-logs-YYYYMMDD-HHmm.zip` にまとめる。zipはAES-256暗号化、パスワードはユーザー入力または `NV_LOG_EXPORT_PASSWORD`。エクスポート完了後はパスとハッシュをトースト表示。

---

## 8. 配布/ライセンス（追補）
- **FFmpegライセンス**：同梱時はLGPL準拠構成、ライセンス文書を`About`に表示。外部利用時は検出後に**バージョン/ライセンス種別**を表示。
- **コード署名/公証**：Windowsは**コード署名**、macOSは**notarization**必須。

---

## 9. テスト/品質保証（追補）
- **契約テスト**：`inspect_concat.request/response.schema.json` への**contract test**をCIで実行。
- **ゴールデンメディア**：再配布非依存の**自動生成スクリプト**で用意（手順は別紙）。

---

## 10. アクセシビリティ/i18n（追補）
- **a11y**：ノード/ポート/接続に `role`/`aria-label`。**キーボード完結**可能をACに追加。
- **翻訳運用**：キー管理、既定`en-US`。未訳は既定へフォールバック。
- **a11y KPI**：クリティカルフロー（ノード追加/接続/実行/エクスポート）は**WCAG 2.1 AA**準拠、`axe-core` 自動チェック違反数を**5件以下**に抑え、リグレッションテストを毎リリースで実行。
- **言語優先順位/レビュー頻度**：公開言語は `en-US` / `ja-JP` を必須、`zh-CN` はP1拡張。リソースフリーズ48時間前にネイティブレビュアが校正し、未完了の場合はリリースノートに欠落文言とETAを明記。

---

## 11. 受け入れ基準（追加）
- **AC-HTTP-TOKEN-001**：`NV_HTTP=1` 時、`X-NodeVision-Token` が未設定/不一致なら401/403で拒否。
- **AC-HTTP-RATE-001**：`/api/inspect/concat` の同時実行が3本目で**429**。
- **AC-MIGRATE-001**：`schemaVersion=1.0.5` のプロジェクトを自動マイグレーションして開ける（失敗時は読み取り専用）。
- **AC-LOG-ROTATE-001**：ジョブログは**最新20件**にローテート。
- **AC-PATHSAFE-001**：UNC/外部ボリューム/未許可拡張子は `E1002/1005`。シンボリックリンクの最終実体がローカル以外なら拒否。
- **AC-ENGINE-QUEUE-001**：`maxParallelJobs=2` で3本目投入時は `Queued` 表示、キュー5件目で `QUEUE_FULL` エラーを返しUIへ警告を表示。
- **AC-HTTP-TOKEN-002**：`nvctl token rotate default` 実行後15分経過した旧トークンでのHTTPリクエストは `401 E4001 TokenExpired` を返し、新トークンでは成功する。
- **AC-LOG-EXPORT-001**：「Export Logs」で生成されたzipがAES-256暗号化であること、トーストに保存パスとSHA256が表示されることをE2Eテストで確認。
- **AC-A11Y-KPI-001**：`pnpm test:a11y` (axe) 実行でクリティカルフローの違反件数が5件以下、`wcagLevel` メタデータがAAであること。

---

## 付録A. ノードのバージョニング/マイグレーション（雛形）
- `nodes/<typeId>/migrations/<nodeVersion>.ts` に**前方互換**の変換関数を用意。  
- 例：`TextOverlay v1→v2`：`fontColor: string → rgba: {r,g,b,a}` の変換。変換不能な値は**警告＋既定値**。

## 変更履歴
- v1.0.7: 並列実行ロードマップ、トークンライフサイクル、ログエクスポート、a11y/i18n KPI、関連ACを追加。
- v1.0.6（本書）：HTTPトークン/レート制限/タイムアウト、スキーママイグレーション、ログローテーション、UI/色管理、配布/署名、a11y/i18n等を追補。
