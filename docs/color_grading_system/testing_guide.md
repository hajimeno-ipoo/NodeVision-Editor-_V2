# カラーグレーディングシステム - 実機テストチェックリスト

## 📋 テスト概要

このドキュメントは、実装したカラーグレーディング機能の動作確認のための実機テストガイドです。
各ノードの接続方法と確認項目を記載しています。

---

## 🔧 事前準備

### 必要なもの
- [ ] テスト用の画像ファイル（JPEG, PNG など）
- [ ] テスト用の動画ファイル（MP4 など、オプション）
- [ ] .cube形式のLUTファイル（オプション）

### アプリケーション起動
```bash
pnpm dev
```

---

## 1️⃣ Color Correctionノードのテスト

### ノード構成図
```
┌─────────────┐     ┌──────────────────┐     ┌───────────────┐
│ Load Image  │────▶│ Color Correction │────▶│ Media Preview │
└─────────────┘     └──────────────────┘     └───────────────┘
```

### 接続手順
1. 左のノードリストから「**Load Image**」をキャンバスにドラッグ
2. Load Imageノードの「Open File」ボタンでテスト画像を選択
3. 「**Color Correction**」ノードをキャンバスに追加
4. 「**Media Preview**」ノードをキャンバスに追加
5. 接続:
   - `Load Image` の `Media` 出力ポート → `Color Correction` の `Source` 入力ポート
   - `Color Correction` の `Result` 出力ポート → `Media Preview` の `Source` 入力ポート

### 確認項目
- [x] ノードが正常に追加できる
- [x] 画像がLoad Imageノードに表示される
- [x] 動画がLoad Videoノードでプレビューされる（静止画だけでなく動画も対応）
- [x] Brightnessスライダーを動かすとプレビューが更新される
- [x] Contrastスライダーを動かすとプレビューが更新される
- [x] Saturationスライダーを動かすとプレビューが更新される
- [x] Gamma, Exposure, Shadows, Highlights, Temperature, Tintも動作する
- [x] 各パラメータのReset（リセット）ボタンが機能する（アイコンクリックで動作、ノード選択されない）

### 期待される結果
- Media Previewノードに色補正された画像が表示される
- 動画の場合もリアルタイムでプレビューされる（WebGLVideoProcessorによる）
- スライダー操作に対してリアルタイムでプレビューが更新される
- WebGL 2.0 (3D LUT)のインジケーターが表示される
- リセットボタンが正しく機能し、アイコンクリックで動作する

---

## 2️⃣ Primary Gradingノード（カラーホイール）のテスト

### ノード構成図
```
┌─────────────┐     ┌──────────────────┐     ┌───────────────┐
│ Load Image  │────▶│ Primary Grading  │────▶│ Media Preview │
└─────────────┘     └──────────────────┘     └───────────────┘
```

### 接続手順
1. Load Imageノードで画像を読み込む
2. **Primary Grading**ノードを追加
3. Media Previewノードを追加
4. 接続:
   - `Load Image` → `Primary Grading` → `Media Preview`

### 確認項目

#### スライダー（上部）
- [x] Exposureスライダーが動作する
- [x] Contrastスライダーが動作する
- [x] Saturationスライダーが動作する
- [x] Temperatureスライダーが動作する
- [x] Tintスライダーが動作する

#### カラーホイール（Lift/Gamma/Gain 縦並列表示）
- [x] Lift（シャドウ）カラーホイールが表示される
- [x] Gamma（ミッドトーン）カラーホイールが表示される
- [x] Gain（ハイライト）カラーホイールが表示される
- [x] カラーホイール上でドラッグすると色相と彩度が調整できる
- [x] 右側のスライダーで輝度（Luminance）が調整できる
- [x] カラーホイール操作時にノードが誤って選択されない
- [x] カラーホイール上部にHue/Sat/Lumの数値が表示され、リアルタイムに更新される
- [x] 数値表示の視認性が確保されている（黒色・太字など）

#### 全体動作・一貫性
- [x] プレビューがリアルタイムで更新される
- [x] 動画プレビュー時もスライダーがスムーズに動作する
- [x] 各リセットボタンが正常に動作する
- [x] **画像プレビューと動画プレビューで色が一致する**（Hueの計算ロジック修正済み）
- [x] **エクスポート結果に色補正が正しく反映される**（FFmpegパイプライン統合済み）

### 期待される結果
- DaVinci Resolveスタイルのカラーホイールで直感的に調整できる
- Lift（シャドウ）、Gamma（ミッドトーン）、Gain（ハイライト）を縦並列で個別調整できる

---

## 3️⃣ Curvesノードのテスト

### ノード構成図
```
┌─────────────┐     ┌────────┐     ┌───────────────┐
│ Load Image  │────▶│ Curves │────▶│ Media Preview │
└─────────────┘     └────────┘     └───────────────┘
```

### 接続手順
1. Load Imageノードで画像を読み込む
2. **Curves**ノードを追加
3. Media Previewノードを追加
4. 接続:
   - `Load Image` → `Curves` → `Media Preview`

### 確認項目

#### RGBカーブ
- [x] Master/Red/Green/Blueタブが表示される
- [x] カーブ上をクリックしてコントロールポイントを追加できる
- [x] コントロールポイントをドラッグして移動できる
- [x] コントロールポイントをダブルクリックで削除できる（両端以外）
- [x] グリッドと対角線（基準線）が表示される
- [x] 各チャンネルで色が異なる（Master:白, Red:赤, Green:緑, Blue:青）

#### Hueカーブ（新機能）
- [x] Hue Hueタブが表示される（色相シフト）
- [x] Hue Satタブが表示される（彩度調整）
- [x] Hue Lumaタブが表示される（輝度調整）
- [x] Hue vs Luma: カーブを下げても色が黒潰れせず、深く濃い色が維持される（DaVinci Resolve挙動）
- [x] Hue vs Luma: カーブを上げると、白飛びせずに鮮やかに発光するような明るさになる
- [x] 各Hueカーブでポイント追加/削除/ドラッグができる
- [x] プレビューがリアルタイムで更新される

#### リセット機能
- [x] 「Reset [チャンネル名]」ボタンで個別チャンネルをリセットできる
- [x] 「Reset All Curves」ボタンで全チャンネルをリセットできる

#### 全体動作・一貫性
- [x] プレビューがリアルタイムで更新される
- [x] ヒストグラム（Input/Output）が表示され、カーブ操作に追従する
- [x] **画像プレビューと動画プレビューで色が一致する**（共通のWebGLLUTProcessorを使用）
- [x] **エクスポート結果にカーブ調整が正しく反映される**（FFmpegパイプライン統合済み）

### 期待される結果
- Catmull-Romスプライン補間による滑らかなカーブ調整（端点も自然に補間）
- 特定の色相に対する高度な調整が可能
- 動画プレビューが元のアスペクト比を維持して表示される
- Hueカーブの変更が動画プレビューに正しく反映される
- 高DPIディスプレイでもマウスクリック位置が正確に判定される

---

## 4️⃣ LUT Loaderノードのテスト

### ノード構成図
```
┌─────────────┐     ┌─────────────┐     ┌───────────────┐
│ Load Image  │────▶│ LUT Loader  │────▶│ Media Preview │
└─────────────┘     └─────────────┘     └───────────────┘
```

### 接続手順
1. Load Imageノードで画像を読み込む
2. **LUT Loader**ノードを追加
3. Media Previewノードを追加
4. 接続:
   - `Load Image` → `LUT Loader` → `Media Preview`

### 確認項目（UI）
- [x] ノードに「ファイル未選択」ドロップダウン（左右ナビ付き）が表示され、初期状態は未選択になっている
- [x] ドロップダウンはLUTライブラリの一覧を表示し、項目を選ぶと即プレビューが更新される
- [x] 「未選択」を選ぶとプレビューがリセットされ、ステータスが「現在適用中: なし」に戻る
- [x] 「LUTファイルを読み込む」ボタンが中央に表示され、ノードを拡大しても中央配置のまま
- [x] 読み込んだLUT名が下部ステータスに表示され、ローカルなら「（ローカル）」、ライブラリなら「（ライブラリ）」と表示される
- [x] 「ライブラリに登録」ボタンでポップアップが開き、名前を付けて登録するとライブラリとドロップダウンに即追加される
- [x] ライブラリから削除した場合、ドロップダウンからも消える

### 確認項目（機能）
- [x] 「LUTファイルを読み込む」で .cube を選択すると即プレビューに適用される
- [x] Intensityスライダーが常に表示され、0〜100%でプレビューがリアルタイムに変化する
- [x] ドロップダウンで別のLUTに切り替えるとプレビューが置き換わる
- [x] 「未選択」を選んだ後、前の補正が残らず素の映像に戻る
- [x] ライブラリ登録時にLUTファイルが `tempRoot/uploads/Luts` にコピーされる（元ファイル移動/削除の影響を受けない）
- [x] ライブラリ追加・削除が他ノードのドロップダウンにも反映される

### 確認項目（カラー一致）
- [x] 画像プレビューと動画プレビューで同じLUTとIntensityを適用したとき色が一致する
- [x] エクスポート結果の色がプレビューと一致する（Intensity<100% のブレンドも同じになる）

### 期待される結果
- 外部/ライブラリの .cube LUT を読み込んで適用できる
- 任意解像度のLUT（17³, 33³, 65³など）に対応し、Intensityブレンドも一致
- ローカル/ライブラリの切替や未選択リセットで表示が即座に反映される

### 注意事項
> .cubeファイルがない場合はこのテストはスキップ可能です。  
> テスト用LUTは以下から入手できます：  
> - [Free LUTs - RocketStock](https://www.rocketstock.com/free-after-effects-templates/35-free-luts-for-color-grading-videos/)

---

## 5️⃣ Secondary Gradingノードのテスト

### ノード構成図
```
┌─────────────┐     ┌────────────────────┐     ┌───────────────┐
│ Load Image  │────▶│ Secondary Grading  │────▶│ Media Preview │
└─────────────┘     └────────────────────┘     └───────────────┘
```

### 接続手順
1. カラフルな画像（複数の色が含まれる）を読み込む
2. **Secondary Grading**ノードを追加
3. Media Previewノードを追加
4. 接続:
   - `Load Image` → `Secondary Grading` → `Media Preview`

### 確認項目

#### HSL Qualifier
- [ ] Hueセクション: Center, Width, Softnessスライダーが動作する
- [ ] Saturationセクション: Center, Width, Softnessスライダーが動作する
- [ ] Luminanceセクション: Center, Width, Softnessスライダーが動作する
- [ ] 「Invert Selection」チェックボックスが機能する
- [ ] 「Show Mask」チェックボックスで選択範囲が白黒表示される

#### Correction
- [ ] Saturationスライダーが選択した色相のみに適用される
- [ ] Hue Shiftスライダーが選択した色相をシフトする
- [ ] Brightnessスライダーが選択した色相の明度を変更する

### 期待される結果
- 特定の色（例：空の青、肌の色）だけを選択して調整できる
- Show Maskで選択範囲を視覚的に確認できる

---

## 6️⃣ Scope Viewerノードのテスト ⭐新機能

### ノード構成図
```
┌─────────────┐     ┌───────────────┐
│ Load Image  │────▶│ Media Preview │
└─────────────┘     └───────────────┘
       │
       └───────────▶┌───────────────┐
                    │ Scope Viewer  │
                    └───────────────┘
```

### 接続手順
1. Load Imageノードでカラフルな画像を読み込む
2. **Scope Viewer**ノードを追加
3. オプションでMedia Previewノードも追加
4. 接続:
   - `Load Image` の `Media` 出力 → `Scope Viewer` の `Source` 入力
   - `Load Image` の `Media` 出力 → `Media Preview` の `Source` 入力（オプション）

### 確認項目
- [ ] Scope Typeドロップダウンが表示される
- [ ] 「RGB Histogram」が選択できる
- [ ] ヒストグラムが自動的に表示される
- [ ] Redチャンネル（赤色、半透明）が表示される
- [ ] Greenチャンネル（緑色、半透明）が表示される
- [ ] Blueチャンネル（青色、半透明）が表示される
- [ ] Luminance（グレー、半透明）が表示される
- [ ] RGBが重なった部分が白っぽく見える
- [ ] 異なる画像を接続すると、ヒストグラムが更新される

### 期待される結果
- 画像の色分布を256ビンで可視化
- プロフェッショナルツールのような重ね合わせ表示

### 将来の機能（Coming Soon表示）
- [ ] Waveform
- [ ] Vectorscope

---

## 7️⃣ 複雑なパイプライン（チェーン接続）のテスト

### ノード構成図
```
┌─────────────┐     ┌──────────────────┐     ┌────────┐     ┌────────────────────┐     ┌───────────────┐
│ Load Image  │────▶│ Primary Grading  │────▶│ Curves │────▶│ Secondary Grading  │────▶│ Media Preview │
└─────────────┘     └──────────────────┘     └────────┘     └────────────────────┘     └───────────────┘
       │
       └───────────▶┌───────────────┐
                    │ Scope Viewer  │
                    └───────────────┘
```

### 接続手順
1. Load Imageノードで画像を読み込む
2. Primary Grading, Curves, Secondary Gradingを順次追加
3. Media PreviewとScope Viewerを追加
4. 上記の図のように接続

### 確認項目
- [ ] 複数のノードを連鎖できる
- [ ] 各段階で色が順次変化する
- [ ] Scope Viewerで元画像の分布を確認できる
- [ ] 最後のMedia Previewに全ての調整が反映される
- [ ] パフォーマンスが許容範囲内（プレビュー更新が1秒以内）

### 期待される結果
- DaVinci Resolveのようなノードベースのワークフロー
- 各ステージで異なる調整を積み重ねられる

---

## 8️⃣ エクスポートのテスト（画像・動画）

### ノード構成図（画像）
```
┌─────────────┐     ┌──────────────────┐     ┌────────┐
│ Load Image  │────▶│ Color Correction │────▶│ Export │
└─────────────┘     └──────────────────┘     └────────┘
```

### ノード構成図（動画）
```
┌─────────────┐     ┌──────────────────┐     ┌────────┐
│ Load Video  │────▶│ Color Correction │────▶│ Export │
└─────────────┘     └──────────────────┘     └────────┘
```

### 接続手順
1. **Load Image** または **Load Video**ノードでメディアを読み込む
2. **Color Correction**ノードで各種パラメータを調整
3. **Export**ノードに接続
4. エクスポート設定を行い、「保存」ボタンをクリック

### 確認項目

#### 基本動作
- [x] Load Imageノードで画像を読み込める
- [x] Load Videoノードで動画を読み込める
- [x] FFmpegで.cubeファイルが生成される
- [x] 書き出されたメディアにカラーグレーディングが適用されている

#### プレビュー・エクスポート色一致テスト ⭐重要
以下の各パラメータで、プレビューとエクスポート結果の色が一致するか確認：

| パラメータ | テスト値 | 確認 |
|-----------|----------|------|
| 色温度 (Temperature) | -100 | [x] 青みがかった色調が一致 |
| 色温度 (Temperature) | +100 | [x] 暖色系の色調が一致 |
| ティント (Tint) | ±50 | [x] 緑/マゼンタ傾向が一致 |
| 彩度 (Saturation) | 0.5 | [x] 彩度低下が一致 |
| 彩度 (Saturation) | 2.0 | [x] 彩度増加が一致 |
| コントラスト (Contrast) | 2.0 | [x] コントラスト強が一致 |
| 露出 (Exposure) | ±1.0 | [x] 明暗が一致 |
| シャドウ (Shadows) | ±50 | [x] 暗部調整が一致 |
| ハイライト (Highlights) | ±50 | [x] 明部調整が一致 |
| ガンマ (Gamma) | 0.5 / 2.0 | [x] 中間調調整が一致 |

#### 出力形式別テスト
- [x] **PNG出力**: `rgb24`ピクセルフォーマットで色が正確
- [x] **MP4出力**: `yuv420p`ピクセルフォーマットで色が正確

### 期待される結果
- プレビューと書き出し結果が完全に一致
- 3D LUT方式により高品質なカラーグレーディング
- 画像出力時はRGBカラースペースを維持
- 動画出力時はYUVカラースペースに適切に変換

### 技術的背景
- プレビュー: WebGLシェーダーによるリアルタイム処理
- エクスポート: 3D LUT（.cube）生成 → FFmpegで適用
- 両方のパイプラインで同一の色変換ロジックを使用することで一致を保証

---

## 🐛 トラブルシューティング

### プレビューが表示されない
1. ブラウザの開発者ツール（Cmd+Option+I）でConsoleを確認
2. ターミナルでエラーメッセージを確認
3. ノードの接続が正しいか確認（ポートの色が一致しているか）

### LUT Loaderでファイルが読めない
- .cube形式のファイルか確認
- ファイルの構文が正しいか確認（`LUT_3D_SIZE`が記載されているか）

### パフォーマンスが遅い
- 画像サイズを小さくする（1920x1080以下推奨）
- 接続するノードの数を減らす
- LUT解像度を下げる（33³推奨）

### Scope Viewerにヒストグラムが表示されない
- 画像が正しく接続されているか確認
- ブラウザのConsoleでエラーを確認
- 画像のファイル形式を確認（JPEG, PNG推奨）

### Color Correctionノードで動画プレビューが黒くなる/表示されない
- WebGLVideoProcessorが正しく初期化されているか確認
- ブラウザの開発者ツールでConsoleエラーを確認
- 動画ファイルの形式が対応しているか確認（MP4, WebM推奨）
- ノードを一度切断して再接続してみる
- アプリを再起動してみる

### リセットボタンをクリックしてもノード選択状態になる
- リセットボタンのアイコン上ではなく、ボタンの縁をクリックしている可能性
- 最新版のコードでは `pointer-events: none` がアイコンに適用済みのため修正済み
- アプリをリロード（Cmd+R）して最新版を反映させる

---

## ✅ テスト完了チェックリスト

以下の項目が全て完了したら、実機テスト成功です！

- [x] Color Correctionノードが正常に動作
- [ ] Primary Gradingノード（カラーホイール）が正常に動作
- [ ] Curvesノード（RGB + Hue）が正常に動作
- [ ] LUT Loaderノードが正常に動作
- [ ] Secondary Gradingノードが正常に動作
- [ ] Scope Viewerノードが正常に動作
- [ ] 複数ノードのチェーン接続が正常に動作
- [x] 画像エクスポートが正常に動作
- [x] 動画エクスポートが正常に動作
- [x] プレビューと書き出し結果が一致（全パラメータ確認済み）

---

## 📝 フィードバック

テスト中に見つかった問題やバグは、以下の情報と一緒に報告してください：

- **発生状況**: どのノードで、どの操作をしたか
- **期待される動作**: 本来どうなるべきか
- **実際の動作**: 実際にどうなったか
- **エラーメッセージ**: Consoleやターミナルのエラー
- **スクリーンショット**: 可能であれば添付

---

**テスト実施日**: _____________

**テスト実施者**: _____________

**全体評価**: ⭐⭐⭐⭐⭐
